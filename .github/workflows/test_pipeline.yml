name: Pipeline test runs

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  unix:
    name: Test run on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: nf-core/setup-nextflow@v2

      - uses: mamba-org/setup-micromamba@v2
        with:
          environment-file: envs/ampliphy.yml
          environment-name: ampliphy
          cache-environment: true
          init-shell: bash

      - name: Run CI
        shell: bash -l {0}
        run: micromamba run -n ampliphy bash .github/bin/ci_unix.sh

  windows-wsl:
    name: Test run on Windows via WSL
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: Vampire/setup-wsl@v6
        with:
          distribution: Ubuntu-22.04
          wsl-version: 2
          update: "true"

      - name: Run CI inside WSL
        shell: wsl-bash {0}
        run: bash .github/bin/ci_wsl.sh